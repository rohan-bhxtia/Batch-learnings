///<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Point Cloud Universe Explorer</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; }
        canvas#three-canvas { display: block; width: 100vw; height: 100vh; }
        #video-container {
            position: absolute; bottom: 20px; right: 20px;
            width: 240px; height: 180px; z-index: 100;
            border: 2px solid rgba(0, 255, 255, 0.5); border-radius: 10px;
            overflow: hidden; background: #000;
        }
        #input-video { width: 100%; height: 100%; transform: rotateY(180deg); object-fit: cover; }
        .output_canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transform: rotateY(180deg); z-index: 101; pointer-events: none; }
        #ui-panel { position: absolute; top: 30px; left: 30px; z-index: 200; color: white; pointer-events: none; }
        .pill { background: rgba(0, 20, 40, 0.8); border-left: 4px solid #00d4ff; padding: 10px 15px; margin-bottom: 10px; border-radius: 4px; font-size: 0.85rem; }
        #status { font-weight: bold; font-size: 1.2rem; color: #00ffcc; }
    </style>
</head>
<body>

<div id="ui-panel">
    <div id="status">SENSORS STANDBY</div>
    <div class="pill"><b>LEFT HAND:</b> Pinch to Zoom</div>
    <div class="pill"><b>RIGHT HAND:</b> Open to Rotate</div>
    <div class="pill"><b>LEFT FIST (Lock):</b> Freeze + Right 2-Finger Scroll</div>
    <div class="pill"><b>BOTH FISTS:</b> Warp Home</div>
</div>

<div id="video-container">
    <video id="input-video" playsinline></video>
    <canvas class="output_canvas"></canvas>
</div>

<canvas id="three-canvas"></canvas>

<script>
/**
 * --- THREE.JS POINT CLOUD ENGINE ---
 */
let scene, camera, renderer, world;
let tPos = new THREE.Vector3(0,0,0), tRot = new THREE.Vector2(0,0), tScale = 1;
let lPos = new THREE.Vector3(0,0,0), lRot = new THREE.Vector2(0,0), lScale = 1;
let anchorR = null, anchorL = null;

function createPointSphere(radius, count, color) {
    const geo = new THREE.BufferGeometry();
    const pos = [];
    for(let i=0; i<count; i++) {
        const u = Math.random(), v = Math.random();
        const theta = 2 * Math.PI * u, phi = Math.acos(2 * v - 1);
        pos.push(radius * Math.sin(phi) * Math.cos(theta));
        pos.push(radius * Math.sin(phi) * Math.sin(theta));
        pos.push(radius * Math.cos(phi));
    }
    geo.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3));
    return new THREE.Points(geo, new THREE.PointsMaterial({ color: color, size: 0.5, transparent: true, opacity: 0.8 }));
}

function initThree() {
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 1, 50000);
    camera.position.z = 800;

    renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('three-canvas'), antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);

    world = new THREE.Group();
    scene.add(world);

    // Sun Point Cloud
    world.add(createPointSphere(50, 5000, 0xffcc00));

    // Planets as Point Clouds...
    const planetSpecs = [
        { d: 250, r: 15, c: 0x00d4ff }, 
        { d: 450, r: 25, c: 0xffaa33 }, 
        { d: 700, r: 35, c: 0x44ffaa }
    ];

    planetSpecs.forEach(spec => {
        const p = createPointSphere(spec.r, 3000, spec.c);
        p.position.x = spec.d;
        world.add(p);
    });

    // Background stars..
    world.add(createPointSphere(5000, 20000, 0xffffff));

    loop();
}

function loop() {
    requestAnimationFrame(loop);
    world.position.lerp(tPos, 0.1);
    world.rotation.y += (tRot.y - world.rotation.y) * 0.1;
    world.rotation.x += (tRot.x - world.rotation.x) * 0.1;
    const s = THREE.MathUtils.lerp(world.scale.x, tScale, 0.1);
    world.scale.set(s,s,s);
    renderer.render(scene, camera);
}

/**
 * --- GESTURE LOGIC ---
 */
const statusText = document.getElementById('status');
const canvasCtx = document.querySelector('.output_canvas').getContext('2d');

function onResults(results) {
    canvasCtx.clearRect(0, 0, canvasCtx.canvas.width, canvasCtx.canvas.height);
    let lHand = null, rHand = null, lFist = false, rFist = false;

    if (results.multiHandLandmarks) {
        results.multiHandedness.forEach((hand, i) => {
            const lm = results.multiHandLandmarks[i];
            const isFist = lm[12].y > lm[10].y && lm[16].y > lm[14].y;
            if(hand.label === "Left") { lHand = lm; lFist = isFist; }
            if(hand.label === "Right") { rHand = lm; rFist = isFist; }
            drawConnectors(canvasCtx, lm, HAND_CONNECTIONS, {color: isFist?'#FF0000':'#00FFFF', lineWidth: 2});
        });
    }

    // RESET
    if (lFist && rFist) {
        statusText.innerText = "RESETTING...";
        tPos.set(0,0,0); tRot.set(0,0); tScale = 1;
        lPos.copy(tPos); lRot.copy(tRot); lScale = tScale;
        anchorR = null; anchorL = null;
        return;
    }

    // ZOOM (Left Hand)
    if (lHand && !lFist) {
        const d = Math.hypot(lHand[4].x - lHand[8].x, lHand[4].y - lHand[8].y);
        if (!anchorL) anchorL = { d: d };
        tScale = Math.max(0.001, Math.min(500, lScale * (d / anchorL.d)));
    } else {
        lScale = tScale; anchorL = null;
    }

    // ROTATE & SCROLL (Right Hand)
    if (rHand) {
        const idx = rHand[8], mid = rHand[12];
        const isTwoFinger = idx.y < rHand[6].y && mid.y < rHand[10].y && rHand[16].y > rHand[14].y;

        if (lFist) { // Master Lock engaged
            if (isTwoFinger) {
                statusText.innerText = "2-FINGER SCROLLING";
                if (!anchorR) anchorR = { x: idx.x, y: idx.y };
                tPos.x = lPos.x + (idx.x - anchorR.x) * 1500;
                tPos.y = lPos.y - (idx.y - anchorR.y) * 1500;
            } else {
                statusText.innerText = "LOCKED - USE 2 FINGERS";
                lPos.copy(tPos); anchorR = null;
            }
        } else if (!rFist) { // Normal rotation
            statusText.innerText = "ROTATING SPACE";
            if (!anchorR) anchorR = { x: idx.x, y: idx.y };
            tRot.y = lRot.y + (idx.x - anchorR.x) * 5;
            tRot.x = lRot.x + (idx.y - anchorR.y) * 5;
        } else {
            lRot.copy(tRot); anchorR = null;
        }
    } else {
        anchorR = null; statusText.innerText = "WAITING...";
    }
}

/**
 * --- STARTUP ---
 */
const hands = new Hands({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}` });
hands.setOptions({ maxNumHands: 2, modelComplexity: 1, minDetectionConfidence: 0.6, minTrackingConfidence: 0.6 });
hands.onResults(onResults);
new Camera(document.getElementById('input-video'), {
    onFrame: async () => await hands.send({image: document.getElementById('input-video')}),
    width: 640, height: 480
}).start();
initThree();
window.addEventListener('resize', () => {
    camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
});
</script>
</body>
</html>
